<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Encom Globe</title>

        <script src="http://code.jquery.com/jquery-2.0.3.min.js"></script>

        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap.min.css">
        <link rel="stylesheet" href="//netdna.bootstrapcdn.com/bootstrap/3.1.1/css/bootstrap-theme.min.css">
        <script src="//netdna.bootstrapcdn.com/bootstrap/3.1.1/js/bootstrap.min.js"></script>

        <link href="styles.css" rel="stylesheet" type="text/css" />

        <script src="include/vec2.js"></script>
        <script src="include/quadtree2.js"></script>
        <script src="include/three.min.js"></script>
        <script src="include/tween.min.js"></script>
        <script src="include/pusher.color.js"></script>
        <script src="data.json"></script>
        <script src="build/encom-globe.js"></script>

        <script>

            var globe = new ENCOM.Globe(window.innerWidth, window.innerHeight, {
                font: "Inconsolata",
                data: data
                });

            var markers = [];

            function onWindowResize(){
                globe.camera.aspect = window.innerWidth / window.innerHeight;
                globe.camera.updateProjectionMatrix();
                globe.renderer.setSize(window.innerWidth, window.innerHeight);

            }

            function roundNumber(num){
                return Math.round(num * 100)/100;
            }

            function projectionToLatLng(width, height, x,y){

                return {
                    lat: 90 - 180*(y/height),
                    lon: 360*(x/width)- 180,
                };

            }

            function addMarker(lat, lon, text){
                if(markers.length > 0){
                    var prev = markers[markers.length-1];
                    markers.push(globe.addMarker(lat, lon, text, prev));
                } else {
                    markers.push(globe.addMarker(lat, lon, text));
                }
                if(markers.length > 4){
                    markers.shift().remove();
                }
            };

            function animate(){
                globe.tick();
                requestAnimationFrame(animate);
            }

            function start(){
                
                $(".toggle-button").click(function(e){
                    var _this = this;
                    $("#" + $(this).attr("id").split("-")[0] + "-input").slideDown(500);
                    $(".toggle-button").each(function(index, element){
                        if(_this != element){
                            $("#" + $(this).attr("id").split("-")[0] + "-input").slideUp(500);
                        }
                    });

                });
                $(".projection").click(function(e){
                    var offset = $(this).offset();
                    var latLon = projectionToLatLng($(".projection").width(), $(".projection").height(), e.clientX - offset.left, e.clientY - offset.top);

                    var selectedId = $("#add-element .selected").attr("id");

                    if(selectedId == "add-pin"){
                        globe.addPin(latLon.lat, latLon.lon, "User Dropped Pin");
                    } else if(selectedId == "add-marker"){
                        addMarker(latLon.lat, latLon.lon, "User Marker");
                    } else if(selectedId == "add-satellite"){
                    console.log("adding sat");
                        globe.addSatellite(latLon.lat, latLon.lon, 1.2);
                    }
                });

                $("#add-element li").click(function(e){
                    $("#add-element li").removeClass("selected");
                    $(e.currentTarget).addClass("selected");

                });

                animate();

                /* add pins at random locations */
                setInterval(function(){
                    
                    var lat = Math.random() * 180 - 90,
                       lon = Math.random() * 360 - 180,
                       name = "Test " + Math.floor(Math.random() * 100);

                    globe.addPin(lat,lon, name);

                }, 1000);
                
                /* add 6 satellites in random locations */
                setTimeout(function(){
                    var constellation = [];

                    for(var i = 0; i< 2; i++){
                        for(var j = 0; j< 3; j++){
                             constellation.push({
                                lat: 50 * i - 30 + 15 * Math.random(), 
                                 lon: 120 * j - 120 + 30 * i, 
                                 altitude: 1.3 + Math.random()/10
                                 });
                        }
                    }

                    globe.addConstellation(constellation);
                }, 4000);

                /* add the connected points that are in the movie */
                setTimeout(function(){
                    addMarker(49.25, -123.1, "Vancouver");
                    addMarker(35.6895, 129.69171, "Tokyo");
                }, 2000);

            }

            function openOptions(){
                var headerTopPosition = $("#header-top").position().top;
                var headerBottomPosition = $("#header-bottom").position().top;
                var headerHeight = $("#header-top").outerHeight(); /* margins or something, whatever */
                $(".header-animator").offset({top: $(document).height()/2, left: 25});
                $(".header-animator").height(0);

                $("#options").data("left", $("#options").css("left"));
                $("#thumbprint").data("left", $("#thumbprint").css("left"));
                $("#options").animate({left: 0}, 500);
                $("#thumbprint").animate({left: 265}, 500);

                $("#options-content").delay(1500).animate({opacity: 1}, 500);

                setTimeout(function(){
                    $(".header-animator").css("visibility", "visible");

                    $("#header-animator-outside").animate({
                        top: headerTopPosition,
                        height: headerBottomPosition - headerTopPosition + headerHeight
                        }, 500);

                    $("#header-animator-inside").animate({
                        top: headerTopPosition + headerHeight,
                        height: headerBottomPosition - headerTopPosition - headerHeight
                        }, 500);
                }, 500);

                setTimeout(function(){
                    $(".header-animator").css("visibility", "hidden");
                    $(".header").css("visibility", "visible");
                }, 1000);

            }

            function closeOptions(){
                $("#options").animate({left: $("#options").data("left")}, 500);
                $("#thumbprint").animate({left: $("#thumbprint").data("left")}, 500);
                $("#options-content").animate({opacity: 0}, 500);
                $(".header").css("visibility", "hidden");
            }

            $(function() {
                var open = false;

                window.addEventListener( 'resize', onWindowResize, false );

                var docHeight = $(document).height();

                $("#options").css({
                    "visibility": "visible",
                    "top": docHeight/2,
                    "bottom": docHeight/2
                    }).animate({
                        "top": 0,
                        "bottom": 0,
                        "height": docHeight,
                        "padding-left": 35,
                        "padding-top": 55
                    },function complete(){
                        $("#thumbprint").animate({opacity: 1});
                        $("#thumbprint").click(function(){
                            if(!open){
                                open = true;
                                openOptions();
                            } else {
                                open = false;
                                closeOptions();
                            }
                        });
                    
                    });

                

                WebFontConfig = {
                    google: {
                          families: ['Inconsolata']
                    },
                    active: function(){
                        /* don't start the globe until the font has been loaded */
                        $("#globe").append(globe.domElement);
                        globe.init(start);
                    }
                };

                /* web font stuff*/
                var wf = document.createElement('script');
                wf.src = ('https:' == document.location.protocol ? 'https' : 'http') +
                    '://ajax.googleapis.com/ajax/libs/webfont/1.4.7/webfont.js';
                wf.type = 'text/javascript';
                wf.async = 'true';
                var s = document.getElementsByTagName('script')[0];
                s.parentNode.insertBefore(wf, s);

            });

        </script>

    </head>
    <body>
        <div id="container">
            <div id="globe">
            </div>
            <div id="options">
                <div id="options-content">
                    Add element by clicking map below
                    <img class="projection" src="resources/point_picker.png" width= "280px"/>
                    <ul id = "add-element">
                        <li id="add-pin" class="selected">Drop Pin</li>
                        <li id="add-marker">Marker</li>
                        <li id="add-satellite">Satellite</li>
                    </ul>
                </div>
            </div>
            <div class="header" id="header-top">
                <div class="header-left-section">CENTRAL SYSTEM DATA ... <span class="alt-1">LAUNCH ENCOM GLOBALIZATION</span></div>
                <div class="header-right-section">OIA | 012</div>
            </div>

            <div class="header" id="header-bottom">
                <div class="header-left-section">TOUCHPOINT KEYBOARD ... <span class="alt-1">INTERACTION SEQUENCING</span></div>
                <div class="header-right-section">SYS | O12</div>
            </div>
            <div id="thumbprint">
                <img src="resources/thumbprint.png" />
            </div>
            <!-- probably should remove these and have them created in the script-->
            <div class="header-animator" id="header-animator-inside"></div>
            <div class="header-animator" id="header-animator-outside"></div>

        </div>
    <body>
</html>

